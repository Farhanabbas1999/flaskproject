{% extends "base.html" %}
{% block title %}Analytics Dashboard{% endblock %}
{% block content %}
<style>
    :root {
        --primary: #3674B5;
        --secondary: #578FCA;
        --light: #A1E3F9;
        --lighter: #D1F8EF;
    }
    .sidebar {
        background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
        width: 250px;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
    }
    .sidebar .nav-link {
        color: #fff !important;
        padding: 12px 15px;
        border-radius: 5px;
        margin-bottom: 5px;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
        background-color: var(--light);
        color: var(--primary) !important;
    }
    .main-content {
        margin-left: 250px;
        padding: 20px;
        background-color: #f8f9fa;
        min-height: 100vh;
    }
    .stat-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card-1 { background: linear-gradient(135deg, #3674B5 0%, #578FCA 100%); color: white; }
    .stat-card-2 { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; }
    .stat-card-3 { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; }
    .stat-card-4 { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
    .chart-card {
        margin-bottom: 20px;
    }
</style>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar text-white p-4">
        <h4 class="mb-4">
            <i class="fas fa-user-shield"></i> Admin Panel
        </h4>
        <hr class="bg-light">
        <nav class="nav flex-column">
            <a class="nav-link" href="{{ url_for('admin.dashboard') }}">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a class="nav-link" href="{{ url_for('admin.users') }}">
                <i class="fas fa-users-cog"></i> Manage Users
            </a>
            <a class="nav-link" href="{{ url_for('admin.doctors') }}">
                <i class="fas fa-user-md"></i> Manage Doctors
            </a>
            <a class="nav-link" href="{{ url_for('admin.nurses') }}">
                <i class="fas fa-user-nurse"></i> Manage Nurses
            </a>
            <a class="nav-link" href="{{ url_for('admin.patients') }}">
                <i class="fas fa-procedures"></i> Manage Patients
            </a>
            <a class="nav-link active" href="{{ url_for('admin.analytics') }}">
                <i class="fas fa-chart-line"></i> Analytics Dashboard
            </a>
            <a class="nav-link" href="{{ url_for('admin.manage_admins') }}">
                <i class="fas fa-user-shield"></i> Manage Admins
            </a>
            <hr class="bg-light">
            <a class="nav-link" href="{{ url_for('auth.logout') }}">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between mb-4">
            <div>
                <h2>Stroke Analytics Dashboard</h2>
                <p class="text-muted">Comprehensive stroke risk analysis from dataset</p>
            </div>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card stat-card-1">
                    <div class="card-body text-center">
                        <h6>Dataset Records</h6>
                        <h2>{{ stats.total_dataset_records }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card stat-card-3">
                    <div class="card-body text-center">
                        <h6>Stroke Cases</h6>
                        <h2>{{ stats.stroke_cases }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card stat-card-2">
                    <div class="card-body text-center">
                        <h6>Registered Patients</h6>
                        <h2>{{ stats.total_patients }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card stat-card-4">
                    <div class="card-body text-center">
                        <h6>System Users</h6>
                        <h2>{{ stats.total_users }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 1: Age and Gender -->
        <div class="row chart-card">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background-color: var(--lighter);">
                        <h5 class="mb-0"><i class="fas fa-birthday-cake"></i> Stroke Cases by Age Group</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="ageChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background-color: var(--lighter);">
                        <h5 class="mb-0"><i class="fas fa-venus-mars"></i> Stroke Cases by Gender</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="genderChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Hypertension and Heart Disease -->
        <div class="row chart-card">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background-color: var(--lighter);">
                        <h5 class="mb-0"><i class="fas fa-heartbeat"></i> Hypertension Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="hypertensionChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background-color: var(--lighter);">
                        <h5 class="mb-0"><i class="fas fa-heart"></i> Heart Disease vs. Stroke</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="heartDiseaseChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Smoking and BMI -->
        <div class="row chart-card">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background-color: var(--lighter);">
                        <h5 class="mb-0"><i class="fas fa-smoking"></i> Smoking Status vs. Stroke</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="smokingChart" height="250"></canvas>
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Legend:</strong> Blue = Stroke Cases, Orange = No Stroke
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background-color: var(--lighter);">
                        <h5 class="mb-0"><i class="fas fa-briefcase"></i> Work Type vs. Stroke</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="workTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Glucose Level -->
        <div class="row chart-card">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background-color: var(--lighter);">
                        <h5 class="mb-0"><i class="fas fa-syringe"></i> Glucose Level Distribution (Stroke vs No Stroke)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="glucoseChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartColors = {
        primary: '#3674B5',
        secondary: '#578FCA',
        success: '#28a745',
        danger: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };

    // 1. Age Chart
    const ageData = {{ age_data | safe }};
    new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(ageData),
            datasets: [{
                label: 'Stroke Cases',
                data: Object.values(ageData),
                backgroundColor: chartColors.primary,
                borderColor: chartColors.secondary,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Number of Cases' } },
                x: { title: { display: true, text: 'Age Group' } }
            }
        }
    });

    // 2. Gender Chart
    const genderData = {{ gender_data | safe }};
    new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(genderData),
            datasets: [{
                data: Object.values(genderData),
                backgroundColor: [chartColors.primary, chartColors.danger, chartColors.warning]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // 3. Hypertension Chart (Pie)
    const hypertensionData = {{ hypertension_data | safe }};
    new Chart(document.getElementById('hypertensionChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(hypertensionData),
            datasets: [{
                data: Object.values(hypertensionData),
                backgroundColor: [chartColors.danger, chartColors.success, chartColors.warning, chartColors.info]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // 4. Heart Disease Chart (Grouped Bar)
    const heartDiseaseData = {{ heart_disease_data | safe }};
    new Chart(document.getElementById('heartDiseaseChart'), {
        type: 'bar',
        data: {
            labels: heartDiseaseData.labels,
            datasets: [
                {
                    label: 'Stroke',
                    data: heartDiseaseData.stroke,
                    backgroundColor: chartColors.danger
                },
                {
                    label: 'No Stroke',
                    data: heartDiseaseData.no_stroke,
                    backgroundColor: chartColors.success
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // 5. Smoking Chart (Grouped Bar with counts)
    const smokingData = {{ smoking_data | safe }};
    new Chart(document.getElementById('smokingChart'), {
        type: 'bar',
        data: {
            labels: smokingData.labels,
            datasets: [
                {
                    label: 'Stroke Cases',
                    data: smokingData.stroke,
                    backgroundColor: smokingData.stroke.map(() => chartColors.primary),
                    borderColor: smokingData.stroke.map(() => chartColors.secondary),
                    borderWidth: 1
                },
                {
                    label: 'No Stroke',
                    data: smokingData.no_stroke,
                    backgroundColor: smokingData.no_stroke.map(() => chartColors.warning),
                    borderColor: smokingData.no_stroke.map(() => chartColors.danger),
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { 
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' cases';
                        }
                    }
                }
            }
        }
    });

    // 6. BMI Chart (Box Plot representation using Bar)
    const bmiStrokeData = {{ bmi_stroke_data | safe }};
    new Chart(document.getElementById('bmiChart'), {
        type: 'bar',
        data: {
            labels: ['Min', 'Q1', 'Median', 'Q3', 'Max'],
            datasets: [
                {
                    label: 'Stroke Patients',
                    data: [
                        bmiStrokeData.stroke.min,
                        bmiStrokeData.stroke.q1,
                        bmiStrokeData.stroke.median,
                        bmiStrokeData.stroke.q3,
                        bmiStrokeData.stroke.max
                    ],
                    backgroundColor: chartColors.danger
                },
                {
                    label: 'No Stroke',
                    data: [
                        bmiStrokeData.no_stroke.min,
                        bmiStrokeData.no_stroke.q1,
                        bmiStrokeData.no_stroke.median,
                        bmiStrokeData.no_stroke.q3,
                        bmiStrokeData.no_stroke.max
                    ],
                    backgroundColor: chartColors.success
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    beginAtZero: true,
                    title: { display: true, text: 'BMI Value' }
                } 
            },
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // 7. Glucose Chart (Line Chart)
    const glucoseStrokeData = {{ glucose_stroke_data | safe }};
    new Chart(document.getElementById('glucoseChart'), {
        type: 'line',
        data: {
            labels: glucoseStrokeData.labels,
            datasets: [
                {
                    label: 'Stroke Cases',
                    data: glucoseStrokeData.stroke,
                    borderColor: chartColors.danger,
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'No Stroke',
                    data: glucoseStrokeData.no_stroke,
                    borderColor: chartColors.success,
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true,
                    title: { display: true, text: 'Number of Cases' }
                },
                x: {
                    title: { display: true, text: 'Glucose Level (mg/dL)' }
                }
            },
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // Work Type vs Stroke Chart
    const workTypeData = {{ work_type_data|safe }};
    new Chart(document.getElementById('workTypeChart'), {
        type: 'bar',
        data: {
            labels: workTypeData.labels || [],
            datasets: [{
                label: 'Stroke Cases',
                data: workTypeData.stroke || [],
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }, {
                label: 'No Stroke',
                data: workTypeData.no_stroke || [],
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
from functools import wraps
from flask import redirect, url_for, flash
from flask_login import current_user

def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not current_user.is_authenticated or current_user.role != 'admin':
            flash('Access denied. Admin privileges required.', 'danger')
            return redirect(url_for('auth.login'))
        return f(*args, **kwargs)
    return decorated_function

@auth.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        role = request.form.get('role')
        
        # Prevent admin registration through normal form
        if role == 'admin':
            flash('Invalid role selection.', 'danger')
            return redirect(url_for('auth.register'))
        
        # Only allow: patient, doctor, nurse
        if role not in ['patient', 'doctor', 'nurse']:
            flash('Invalid role.', 'danger')
            return redirect(url_for('auth.register'))
        
        # Continue with registration...
@auth.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        user = User.query.filter_by(username=username).first()
        
        if user and check_password_hash(user.password, password):
            login_user(user)
            
            # Role-based redirection
            if user.role == 'admin':
                return redirect(url_for('admin.dashboard'))
            elif user.role == 'doctor':
                return redirect(url_for('doctor.dashboard'))
            elif user.role == 'nurse':
                return redirect(url_for('nurse.dashboard'))
            else:
                return redirect(url_for('patient.dashboard'))

# In your main app file or a separate management script
import click
from flask.cli import with_appcontext

@click.command('create-admin')
@click.option('--username', prompt=True)
@click.option('--email', prompt=True)
@click.option('--password', prompt=True, hide_input=True, confirmation_prompt=True)
@with_appcontext
def create_admin(username, email, password):
    """Create an admin user."""
    from app.models import User
    from werkzeug.security.security import generate_password_hash
    
    if User.query.filter_by(username=username).first():
        click.echo('User already exists!')
        return
    
    admin = User(
        username=username,
        email=email,
        password=generate_password_hash(password),
        role='admin'
    )
    db.session.add(admin)
    db.session.commit()
    click.echo(f'Admin user {username} created successfully!')

# Register the command
app.cli.add_command(create_admin)

@app.after_request
def set_security_headers(response):
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    return response